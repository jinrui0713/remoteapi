<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン - YtDlp Server</title>
    <link rel="manifest" href="/static/manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-dark d-flex align-items-center justify-content-center" style="height: 100vh;">
    <!-- Notification Permission Overlay -->
    <div id="notifOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;">
        <button type="button" class="btn-close btn-close-white" style="position: absolute; top: 15px; right: 15px; width: 0.5em; height: 0.5em; background-size: 0.5em;" aria-label="Close" onclick="document.getElementById('notifOverlay').style.display='none'"></button>
        <div class="text-center p-4">
            <h3 class="mb-3">通知の許可が必要です</h3>
            <p>このサービスを利用するには通知の許可が必要です。<br>通知を許可しないと利用できません。</p>
            <button id="btnAllowNotif" class="btn btn-primary btn-lg mt-3">通知を許可する</button>
        </div>
    </div>

    <div class="card shadow p-4" style="width: 100%; max-width: 400px;">
        <ul class="nav nav-tabs mb-3" id="authTabs">
            <li class="nav-item">
                <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login-pane" type="button">ログイン</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register-pane" type="button">登録</button>
            </li>
        </ul>
        
        <div class="tab-content" id="authTabContent">
            <!-- Login -->
            <div class="tab-pane fade show active" id="login-pane">
                <form id="loginForm">
                    <div class="mb-3">
                        <label class="form-label">ユーザー名</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">パスワード</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="mb-3">
                         <small class="text-danger">パスワードを忘れた場合は管理者にご連絡ください。</small>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">ログイン</button>
                </form>
            </div>
            
            <!-- Register -->
            <div class="tab-pane fade" id="register-pane">
                <form id="registerForm">
                    <div class="mb-3">
                        <label class="form-label">希望するニックネーム (ユーザー名)</label>
                        <input type="text" class="form-control" id="reg-nickname" required minlength="3">
                        <small class="text-muted">承認に使用されます。</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">パスワード</label>
                        <input type="password" class="form-control" id="reg-password" required minlength="4" maxlength="20" pattern="[A-Za-z0-9]+" title="4〜20文字の英数字">
                        <small class="text-muted">4文字以上20文字以下の英数字</small>
                    </div>
                    <button type="submit" class="btn btn-success w-100">登録リクエスト</button>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Check Notification Permission on Load
        document.addEventListener('DOMContentLoaded', () => {
            const overlay = document.getElementById('notifOverlay');
            
            // iOS PWA Detection
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
            
            function checkPermission() {
                if (Notification.permission === 'granted') {
                    overlay.style.display = 'none';
                    return;
                }
                
                overlay.style.display = 'flex';
                const msgP = document.querySelector('#notifOverlay p');
                const btn = document.getElementById('btnAllowNotif');

                // iOS needs PWA for notifications (usually)
                if (isIOS && !isStandalone) {
                     msgP.innerHTML = '<span class="fw-bold text-warning">iOSで通知を利用するには、ホーム画面に追加する必要があります。</span><br>Safariの「共有」ボタン <i class="bi bi-box-arrow-up"></i> から「ホーム画面に追加」を選択し、そのアイコンからアプリを起動してください。<br><br><small class="text-white-50">どうしても通知なしで利用したい場合は<a href="#" class="text-white" onclick="document.getElementById(\'notifOverlay\').style.display=\'none\'; return false;">こちら</a> (推奨されません)</small>';
                     btn.textContent = "ホーム画面に追加してください";
                     btn.disabled = true;
                     btn.className = "btn btn-secondary btn-lg mt-3";
                } else if (Notification.permission === 'denied') {
                    msgP.innerHTML = '<span class="text-danger fw-bold">通知がブロックされています。ブラウザの設定から通知を許可してください。</span><br>許可しないとこのサービスは利用できません。<br><br><small class="text-white-50">リセット方法: ブラウザの設定 -> サイトの設定 -> 通知 -> リセット</small>';
                }
            }

            document.getElementById('btnAllowNotif').addEventListener('click', () => {
                if (isIOS && !isStandalone) return;
                
                Notification.requestPermission().then(permission => {
                    checkPermission();
                    if (permission === 'granted') {
                         window.location.reload();
                    } else if (permission === 'denied') {
                        alert('通知を許可しないとこのサービスは利用できません。');
                    }
                });
            });

            checkPermission();
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const is_pwa = window.matchMedia('(display-mode: standalone)').matches;
            
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password, is_pwa})
                });
                if (res.ok) {
                    window.location.href = '/';
                } else {
                    const data = await res.json().catch(() => ({}));
                    alert(data.detail || '認証に失敗しました');
                }
            } catch (e) {
                alert('ログインエラー');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nickname = document.getElementById('reg-nickname').value;
            const password = document.getElementById('reg-password').value;
            
            const info = {
                nickname, 
                password,
                ua: navigator.userAgent,
                screen: `${window.screen.width}x${window.screen.height}`
            };

            try {
                const res = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(info)
                });
                
                const data = await res.json();
                if (res.ok) {
                    alert('登録リクエスト送信完了！管理者の承認をお待ちください。');
                    // Switch to login tab
                    document.getElementById('login-tab').click();
                } else {
                    if (data.detail === 'Username already taken') {
                        alert('このユーザー名は既に使用されています。ログインするか、別の名前を使用してください。');
                    } else {
                        alert(data.detail || '登録失敗');
                    }
                }
            } catch (e) {
                alert('リクエストエラー');
            }
        });
    </script>
</body>
</html>